@page
@model JoinModel
@{
    ViewData["Title"] = "Join Quiz";
}

<div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-50 to-pink-50 p-6">
    <div class="w-full max-w-md">
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h1 class="text-2xl font-bold text-slate-800">Join the Quiz</h1>
            <p class="text-sm text-slate-500 mt-1">Enter your name and join the session on your phone.</p>

            <div id="joinForm" class="mt-6 space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-slate-700">Your Name</label>
                    <input type="text" id="username" class="mt-1 block w-full rounded-md border border-slate-200 p-3 shadow-sm" placeholder="e.g., Alex" />
                </div>

                <button onclick="joinQuiz()" class="w-full bg-purple-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-purple-700">Join</button>
            </div>

            <div id="quizView" class="hidden mt-6 space-y-4">
                <div id="questionDisplay" class="text-xl font-semibold text-slate-800">
                    Waiting for question...
                </div>
                <div>
                    <label for="answer" class="block text-sm font-medium text-slate-700">Your Answer</label>
                    <input type="text" id="answer" class="mt-1 block w-full rounded-md border border-slate-200 p-3 shadow-sm" placeholder="Type your answer" />
                </div>
                <button onclick="submitAnswer()" class="w-full bg-pink-500 text-white px-4 py-3 rounded-lg font-semibold hover:bg-pink-600">Submit Answer</button>
            </div>
        </div>

        <div class="mt-4 text-center text-xs text-slate-500">Tip: Use your phone to answer while the host displays questions on a big screen.</div>
        
        <!-- Warning Modal -->
        <div id="warningModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div class="bg-white p-6 rounded-lg max-w-md mx-4">
                <h3 class="text-xl font-bold text-red-600">Warning!</h3>
                <p class="mt-2 text-gray-600">Switching away from the quiz may be considered cheating. Please stay focused on the quiz.</p>
                <button onclick="closeWarningModal()" class="mt-4 w-full bg-red-600 text-white px-4 py-2 rounded-lg">I Understand</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Html.Raw("<script src=\"https://cdn.jsdelivr.net/npm/@microsoft/signalr@8/dist/browser/signalr.js\"></script>")
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/quizHub")
            .withAutomaticReconnect()
            .build();

        // Track if user is in quiz mode
        let inQuizMode = false;
        let switchCount = 0;
        const MAX_SWITCHES = 3;

        // Handle visibility change
        document.addEventListener('visibilitychange', function() {
            if (inQuizMode) {
                if (document.hidden) {
                    switchCount++;
                    showWarningModal();
                    connection.invoke("ReportVisibilityChange", switchCount)
                        .catch(console.error);
                    
                    if (switchCount >= MAX_SWITCHES) {
                        document.getElementById("answer").disabled = true;
                        alert("You have switched away too many times. Your answers will be marked as potentially invalid.");
                    }
                }
            }
        });

        // Warn before leaving
        window.addEventListener('beforeunload', function(e) {
            if (inQuizMode) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        function showWarningModal() {
            document.getElementById('warningModal').classList.remove('hidden');
        }

        function closeWarningModal() {
            document.getElementById('warningModal').classList.add('hidden');
        }

        connection.on("NewQuestion", (question) => {
            document.getElementById("questionDisplay").textContent = question;
            document.getElementById("answer").value = "";
            document.getElementById("answer").disabled = false;
        });

        connection.on("JoinFailed", (errorMessage) => {
            alert("Join Failed: " + errorMessage);
            // Clear localStorage and input on failed join
            localStorage.removeItem('quiz_username');
            document.getElementById("username").value = "";
            document.getElementById("username").focus();
        });

        connection.on("QuizResults", (data) => {
            // Find this user's results
            const thisUser = data.Results.find(r => r.Name === document.getElementById("username").value.trim());
            
            if (thisUser) {
                let answersText = thisUser.Answers.map((a, idx) => `Q${idx + 1}: ${a.Answer}`).join('\n');
                alert(`Quiz Complete!\n\nYour Answers:\n${answersText || 'No answers submitted'}\n\nTab Switches: ${thisUser.SwitchCount}`);
            } else {
                alert("Quiz results are being displayed!");
            }
        });

        function joinQuiz() {
            const username = document.getElementById("username").value.trim();
            if (!username) { 
                alert("Please enter your name"); 
                return; 
            }

            // Attempt join via SignalR
            connection.invoke("JoinQuiz", username)
                .then(() => {
                    // Only save to localStorage and show quiz view on successful join
                    localStorage.setItem('quiz_username', username);
                    document.getElementById("joinForm").classList.add("hidden");
                    document.getElementById("quizView").classList.remove("hidden");
                    inQuizMode = true;
                })
                .catch(err => {
                    console.error("Join error:", err);
                    alert("Join error: " + err.message);
                });
        }

        function submitAnswer() {
            const answer = document.getElementById("answer").value.trim();
            if (!answer) { alert("Please enter an answer"); return; }

            connection.invoke("SubmitAnswer", answer)
                .then(() => {
                    document.getElementById("answer").disabled = true;
                })
                .catch(console.error);
        }

        // Auto-fill username if present
        document.addEventListener('DOMContentLoaded', () => {
            const name = localStorage.getItem('quiz_username');
            if (name) document.getElementById('username').value = name;
        });

        connection.start().catch(console.error);
    </script>
}