@page
@model IndexModel
@{
    ViewData["Title"] = "Fun App by Sameer";
}

<div class="h-screen flex flex-col bg-gradient-to-b from-purple-600 via-pink-500 to-orange-400">
    <!-- Top Navigation Bar -->
    <div class="bg-black/20 backdrop-blur-sm border-b border-white/10">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-extrabold text-white">Fun App by Sameer</h1>
                <div class="text-sm text-white/80">
                    Participants: <span id="participantCount" class="font-bold text-white">0</span>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button id="selectIndividual" class="px-3 py-1 bg-white text-purple-700 font-semibold rounded text-sm hover:scale-[1.05] transition">Individual Players</button>
                <button id="selectCouple" class="px-3 py-1 bg-white/20 text-white font-semibold rounded text-sm hover:scale-[1.05] transition">Couple Players</button>
                <a href="/Admin" class="px-3 py-1 bg-blue-600 text-white font-semibold rounded text-sm hover:scale-[1.05] transition">Manage</a>
            </div>

            <button id="menuToggle" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition">
                ? Menu
            </button>
        </div>
    </div>

    <div class="flex-1 flex items-center justify-center p-6 overflow-hidden">
        <div class="w-full max-w-4xl">
            <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-8 mb-6 border border-white/20">
                <div id="questionDisplay" class="text-4xl md:text-5xl font-bold text-white text-center leading-tight">Waiting to start...</div>
                <div class="mt-4 text-center text-white/80">Press Next Question to begin</div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" id="answersContainer"></div>
            <div class="flex flex-wrap items-center justify-center gap-3">
                <button id="nextQuestion" class="px-6 py-3 bg-white text-purple-700 font-bold rounded-lg shadow-lg hover:scale-[1.05] transition text-lg">? Next Question</button>
                <button id="revealAnswers" class="px-6 py-3 bg-blue-500 text-white font-bold rounded-lg shadow-lg hover:scale-[1.05] transition text-lg">?? Reveal Answers</button>
                <button id="showResults" class="px-6 py-3 bg-yellow-500 text-white font-bold rounded-lg shadow-lg hover:scale-[1.05] transition text-lg">?? Show Results</button>
                <button id="clearAnswers" class="px-6 py-3 bg-white/20 text-white font-bold rounded-lg hover:bg-white/30 transition text-lg">?? Clear</button>
            </div>
        </div>
    </div>

    <!-- Side Menu -->
    <div id="sideMenu" class="hidden fixed right-0 top-0 h-screen w-80 bg-white shadow-2xl z-40 flex flex-col">
        <div class="bg-gradient-to-r from-purple-600 to-pink-500 p-6 flex justify-between items-center">
            <h2 class="text-xl font-bold text-white">Menu</h2>
            <button id="menuClose" class="text-white text-2xl hover:scale-[1.2] transition">?</button>
        </div>

        <!-- Activity Log Section -->
        <div class="flex-1 p-6 overflow-y-auto border-b">
            <h3 class="text-lg font-bold text-slate-800 mb-4">?? Activity Log</h3>
            <div id="activityLog" class="space-y-2 text-sm"></div>
        </div>

        <!-- Join Info Section -->
        <div class="p-6 bg-slate-50 border-t">
            <h3 class="text-lg font-bold text-slate-800 mb-4">?? Join This Quiz</h3>
            <p class="text-sm text-slate-600 mb-3">Share this link with participants:</p>
            
            <div class="flex gap-2 mb-4">
                <input id="joinUrl" type="text" readonly class="flex-1 p-2 border border-slate-300 rounded text-sm" value="@Model.JoinUrl" />
                <button onclick="copyJoinUrl()" class="px-3 py-2 bg-purple-600 text-white rounded font-semibold text-sm hover:bg-purple-700">
                    Copy
                </button>
            </div>

            <div class="space-y-2 mb-4">
                <button id="viewParticipants" class="w-full py-2 bg-blue-100 text-blue-700 rounded font-semibold text-sm hover:bg-blue-200">
                    ?? View Participants
                </button>
                <button id="generateLink" class="w-full py-2 bg-green-100 text-green-700 rounded font-semibold text-sm hover:bg-green-200">
                    ?? Generate Link
                </button>
            </div>

            <div id="generatedLinks" class="text-xs text-slate-600 space-y-1"></div>
        </div>
    </div>

    <!-- Menu Overlay -->
    <div id="menuOverlay" class="hidden fixed inset-0 bg-black/30 z-30"></div>

    <!-- Results Modal -->
    <div id="resultsModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="sticky top-0 bg-gradient-to-r from-purple-600 to-pink-500 p-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-white">Quiz Results</h2>
                <div class="flex gap-2">
                    <button onclick="exportResults()" class="text-xs px-3 py-1 bg-white/20 hover:bg-white/30 rounded text-white">Export</button>
                    <button onclick="closeResults()" class="text-white text-2xl hover:scale-[1.2] transition">?</button>
                </div>
            </div>
            <div id="resultsList" class="p-6 grid gap-4 sm:grid-cols-2"></div>
        </div>
    </div>
</div>

@section Scripts {
    @Html.Raw("<script src=\"https://cdn.jsdelivr.net/npm/@microsoft/signalr@8/dist/browser/signalr.js\"></script>")
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/quizHub")
            .withAutomaticReconnect()
            .build();

        let participants = {};
        let maxActivityLogEntries = 20;

        function syncParticipantCount() {
            const count = Object.keys(participants).length;
            document.getElementById('participantCount').textContent = count;
            
            // Warn if approaching limits
            if (count >= 15) {
                console.warn(`?? High participant count: ${count}. May approach ngrok free tier limits.`);
            }
        }

        // Menu Toggle Functions
        function openMenu() {
            document.getElementById("sideMenu").classList.remove("hidden");
            document.getElementById("menuOverlay").classList.remove("hidden");
        }

        function closeMenu() {
            document.getElementById("sideMenu").classList.add("hidden");
            document.getElementById("menuOverlay").classList.add("hidden");
        }

        document.getElementById("menuToggle").addEventListener("click", openMenu);
        document.getElementById("menuClose").addEventListener("click", closeMenu);
        document.getElementById("menuOverlay").addEventListener("click", closeMenu);

        // Results Modal Functions
        function openResults() {
            document.getElementById("resultsModal").classList.remove("hidden");
        }

        function closeResults() {
            document.getElementById("resultsModal").classList.add("hidden");
        }

        // Activity log handling
        function addActivityLog(message) {
            const log = document.getElementById('activityLog');
            const entry = document.createElement('div');
            entry.className = 'p-2 bg-slate-100 rounded text-slate-700 text-xs';
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            log.insertBefore(entry, log.firstChild);
            
            // Keep only last 20 entries
            while (log.children.length > maxActivityLogEntries) {
                log.removeChild(log.lastChild);
            }
        }

        // SignalR Event Handlers
        connection.on("UserJoined", (user) => {
            const cid = user.connectionId || user.ConnectionId;
            const name = user.name || user.Name || 'Unknown';
            if (!cid) return;
            participants[cid] = { connectionId: cid, name };
            syncParticipantCount();
            addActivityLog(`? ${name} joined`);
        });

        connection.on("UserLeft", (user) => {
            const cid = user.connectionId || user.ConnectionId;
            const name = user.name || user.Name || 'Unknown';
            if (cid) {
                delete participants[cid];
                syncParticipantCount();
                addActivityLog(`? ${name} left`);
            }
        });

        connection.on("UserSwitchedAway", (data) => {
            const name = data.UserName || data.userName || 'Unknown';
            const count = data.SwitchCount || data.switchCount || 0;
            addActivityLog(`?? ${name} switched away (${count}x)`);
        });

        connection.on("NewQuestion", (question) => {
            document.getElementById("questionDisplay").textContent = question;
            document.getElementById("answersContainer").innerHTML = "";
            addActivityLog(`? New question asked`);
        });

        connection.on("GameModeChanged", (mode) => {
            addActivityLog(`?? Mode: ${mode}`);
        });

        connection.on("QuizEnded", (results) => {
            renderResults(results);
        });

        function renderResults(results) {
            const resultsList = document.getElementById("resultsList");
            resultsList.innerHTML = "";
            
            console.log("Rendering results:", results); // Debug logging
            
            if (!results || results.length === 0) {
                resultsList.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-full">No results yet</p>';
                openResults();
                return;
            }
            
            results.forEach(result => {
                console.log("Processing result:", result); // Debug logging
                
                const name = result.Name || result.name || 'Unknown';
                const switchCount = result.SwitchCount !== undefined ? result.SwitchCount : (result.switchCount || 0);
                const answersList = result.Answers || result.answers || [];
                
                console.log(`User: ${name}, Switches: ${switchCount}, Answers:`, answersList); // Debug logging
                
                let answersHtml = '';
                if (answersList && answersList.length > 0) {
                    answersHtml = answersList.map((a, idx) => {
                        // Handle both object format {Answer: "text"} and plain string format
                        let answerText;
                        if (typeof a === 'string') {
                            answerText = a;
                        } else if (a && (a.Answer || a.answer)) {
                            answerText = a.Answer || a.answer;
                        } else if (a && typeof a === 'object') {
                            answerText = JSON.stringify(a);
                        } else {
                            answerText = String(a);
                        }
                        
                        // Escape HTML to prevent XSS
                        const escapedAnswer = answerText.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                        
                        return `<p class="text-xs text-slate-600">Q${idx + 1}: <span class="font-semibold">${escapedAnswer}</span></p>`;
                    }).join('');
                } else {
                    answersHtml = '<p class="text-xs text-slate-400">No answers submitted</p>';
                }
                
                const card = document.createElement('div');
                card.className = 'p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border border-purple-200';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-bold text-lg text-purple-700">${name}</div>
                        <div class="text-xs bg-orange-200 text-orange-800 px-2 py-1 rounded">?? ${switchCount} switches</div>
                    </div>
                    <div class="space-y-1">${answersHtml}</div>`;
                resultsList.appendChild(card);
            });
            
            openResults();
            addActivityLog("?? Results displayed");
        }

        // Button Handlers
        document.getElementById("nextQuestion").addEventListener("click", () => {
            connection.invoke("NextQuestion").catch(err => console.error(err));
        });

        document.getElementById("clearAnswers").addEventListener("click", () => {
            document.getElementById("answersContainer").innerHTML = "";
            addActivityLog("??? Answers cleared");
        });

        document.getElementById("revealAnswers").addEventListener("click", () => {
            connection.invoke("GetCurrentAnswers")
                .then(answers => {
                    console.log("GetCurrentAnswers response:", answers);
                    const answersContainer = document.getElementById("answersContainer");
                    answersContainer.innerHTML = "";
                    
                    if (!answers || answers.length === 0) {
                        answersContainer.innerHTML = '<p class="text-white text-center col-span-full">No answers yet</p>';
                        addActivityLog("??? Revealed: No answers");
                        return;
                    }
                    
                    answers.forEach(answer => {
                        // Handle both PascalCase and camelCase properties
                        const user = answer.User || answer.user;
                        const userName = user ? (user.Name || user.name || 'Unknown') : 'Unknown';
                        const answerText = answer.Answer || answer.answer || '';
                        
                        const card = document.createElement('div');
                        card.className = 'bg-white/90 p-4 rounded-lg shadow-sm backdrop-blur-sm animate-bounce';
                        card.innerHTML = `
                            <div class="font-semibold text-purple-700">${userName}</div>
                            <div class="mt-1 text-sm text-slate-700 break-words">${answerText}</div>
                        `;
                        answersContainer.appendChild(card);
                    });
                    
                    addActivityLog(`??? Revealed ${answers.length} answers`);
                })
                .catch(err => {
                    console.error("Error revealing answers:", err);
                    addActivityLog("? Error revealing answers");
                });
        });

        document.getElementById("selectIndividual").addEventListener("click", () => {
            connection.invoke("SetGameMode", "Individual").then(() => {
                document.getElementById("selectIndividual").classList.add("bg-white", "text-purple-700");
                document.getElementById("selectIndividual").classList.remove("bg-white/20", "text-white");
                document.getElementById("selectCouple").classList.remove("bg-white", "text-purple-700");
                document.getElementById("selectCouple").classList.add("bg-white/20", "text-white");
            }).catch(err => console.error(err));
        });

        document.getElementById("selectCouple").addEventListener("click", () => {
            connection.invoke("SetGameMode", "Couple").then(() => {
                document.getElementById("selectCouple").classList.add("bg-white", "text-pink-700");
                document.getElementById("selectCouple").classList.remove("bg-white/20", "text-white");
                document.getElementById("selectIndividual").classList.remove("bg-white", "text-purple-700");
                document.getElementById("selectIndividual").classList.add("bg-white/20", "text-white");
            }).catch(err => console.error(err));
        });

        document.getElementById("generateLink").addEventListener("click", () => {
            const id = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
            const link = `${window.location.origin}/join/${id}`;
            const container = document.getElementById('generatedLinks');
            const el = document.createElement('div');
            el.className = 'p-2 bg-green-100 rounded text-xs text-green-800 break-all';
            el.textContent = link;
            container.insertBefore(el, container.firstChild);
        });

        document.getElementById("viewParticipants").addEventListener("click", () => {
            const names = Object.values(participants).map(p => p.name).join('\n');
            alert(`Participants (${Object.keys(participants).length}):\n${names || 'None yet'}`);
        });

        document.getElementById("showResults").addEventListener("click", () => {
            console.log("Show Results button clicked");
            connection.invoke("GetAllUserAnswers")
                .then(results => { 
                    console.log("GetAllUserAnswers response:", results);
                    renderResults(results); 
                })
                .catch(err => { 
                    console.error("Error fetching results:", err); 
                    addActivityLog("? Error displaying results"); 
                    alert("Error fetching results: " + err.message);
                });
        });

        function copyJoinUrl() {
            const joinUrl = document.getElementById("joinUrl");
            joinUrl.select();
            document.execCommand("copy");
            alert("Link copied!");
        }

        function exportResults() {
            const rows = [['Name','Switches','Answer#','Answer']];
            const cards = document.querySelectorAll('#resultsList > div');
            cards.forEach(card => {
                const name = card.querySelector('.font-bold').textContent.trim();
                const switches = card.querySelector('.bg-orange-200')?.textContent.replace(/[^0-9]/g,'') || '0';
                const answers = card.querySelectorAll('.space-y-1 p');
                if (answers.length === 0) rows.push([name,switches,'','']);
                answers.forEach((p, idx) => {
                    const txt = p.textContent.replace(/Q[0-9]+:\s*/,'')
                    rows.push([name,switches,(idx+1).toString(),txt]);
                });
            });
            const csv = rows.map(r => r.map(v => '"'+v.replace('"','""')+'"').join(',')).join('\n');
            const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href=url; a.download='quiz-results.csv'; a.click(); URL.revokeObjectURL(url);
        }

        connection.start().then(() => {
            connection.invoke("GetParticipants").then(list => {
                participants = {};
                (list || []).forEach(u => {
                    const cid = u.connectionId || u.ConnectionId;
                    const name = u.name || u.Name || 'Unknown';
                    if (cid) {
                        participants[cid] = { connectionId: cid, name };
                    }
                });
                syncParticipantCount();
            }).catch(err => console.error("GetParticipants error", err));
        }).catch(err => console.error("SignalR start failed", err));
    </script>
}
