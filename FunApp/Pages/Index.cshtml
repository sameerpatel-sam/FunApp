@page
@model IndexModel
@{
    ViewData["Title"] = "Fun Quiz App";
}

<div class="container mx-auto p-6">
    <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden grid grid-cols-1 md:grid-cols-3">
        <!-- Left: Host Panel -->
        <div class="md:col-span-2 p-8 bg-gradient-to-b from-purple-600 via-pink-500 to-orange-400 text-white">
            <div class="flex items-start justify-between">
                <div>
                    <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">Fun Quiz</h1>
                    <p class="mt-2 opacity-90">Play together in real time — display a question and collect answers from everyone.</p>
                </div>
                <div class="text-right">
                    <div class="text-sm opacity-90">Participants</div>
                    <div id="participantCount" class="text-2xl font-bold">0</div>
                </div>
            </div>

            <div class="mt-8 bg-white/10 rounded-xl p-6">
                <div id="questionDisplay" class="text-2xl md:text-3xl font-semibold">Waiting to start...</div>
                <div class="mt-4 text-sm opacity-80">Tip: Press Next Question to start the fun.</div>

                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4" id="answersContainer"></div>
            </div>

            <div class="mt-6 flex items-center gap-4">
                <button id="nextQuestion" class="bg-white text-purple-700 font-semibold px-5 py-3 rounded-lg shadow hover:scale-[1.02] transition">Next Question</button>
                <button id="clearAnswers" class="bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition">Clear Answers</button>
                <button id="showResults" class="bg-green-500 text-white font-semibold px-5 py-3 rounded-lg shadow hover:scale-[1.02] transition">Show Results</button>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden mt-8 bg-white/10 rounded-xl p-6">
                <h2 class="text-2xl font-bold mb-4">Quiz Results</h2>
                <div id="resultsList" class="space-y-4"></div>
            </div>

            <!-- Activity Log -->
            <div class="mt-6 bg-white/10 rounded-lg p-4">
                <h3 class="text-sm font-semibold mb-2">Activity Log</h3>
                <div id="activityLog" class="text-sm space-y-1 max-h-32 overflow-y-auto"></div>
            </div>
        </div>

        <!-- Right: Join Info Panel -->
        <div class="p-6 bg-slate-50">
            <div class="bg-white rounded-xl p-6 shadow">
                <h3 class="text-lg font-semibold">Join this quiz</h3>
                <p class="text-sm text-slate-600 mt-2">Share this link with participants so they can join on their phones.</p>

                <div class="mt-4 flex gap-2">
                    <input id="joinUrl" type="text" readonly class="flex-1 p-3 rounded-lg border border-slate-200 text-sm" value="@Model.JoinUrl" />
                    <button onclick="copyJoinUrl()" class="px-4 py-2 bg-purple-600 text-white rounded-lg">Copy</button>
                </div>

                <div class="mt-6">
                    <h4 class="text-sm font-medium text-slate-700">Quick Controls</h4>
                    <div class="mt-3 grid grid-cols-1 gap-2">
                        <button id="generateLink" class="w-full py-2 rounded-md border border-dashed border-slate-200 text-sm">Generate User Link</button>
                        <button id="viewParticipants" class="w-full py-2 rounded-md bg-slate-100 text-sm">View Participants</button>
                    </div>
                </div>

                <div id="generatedLinks" class="mt-4 text-sm text-slate-600"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Html.Raw("<script src=\"https://cdn.jsdelivr.net/npm/@microsoft/signalr@8/dist/browser/signalr.js\"></script>")
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/quizHub")
            .withAutomaticReconnect()
            .build();

        let participants = {};

        // Activity log handling
        function addActivityLog(message) {
            const log = document.getElementById('activityLog');
            const entry = document.createElement('div');
            entry.className = 'py-1 border-b border-white/10';
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            log.insertBefore(entry, log.firstChild);
        }

        // Show a temporary banner on the host screen when a participant switches away
        function showSwitchBanner(name, count) {
            // Remove existing banner if present
            const existing = document.getElementById('switchBanner');
            if (existing) existing.remove();

            const banner = document.createElement('div');
            banner.id = 'switchBanner';
            banner.className = 'fixed top-4 left-1/2 -translate-x-1/2 bg-yellow-300 text-black px-4 py-2 rounded shadow z-50';
            banner.textContent = `${name} switched away (${count} times)`;
            document.body.appendChild(banner);

            // Auto-remove after 4 seconds
            setTimeout(() => banner.remove(), 4000);
        }

        connection.on("UserSwitchedAway", (data) => {
            // SignalR payload uses C# property names; accept either casing for robustness
            const userName = data.UserName ?? data.userName ?? 'Unknown participant';
            const switchCount = data.SwitchCount ?? data.switchCount ?? 0;

            addActivityLog(`${userName} switched away from quiz (${switchCount} times)`);
            showSwitchBanner(userName, switchCount);
        });

        connection.on("UserJoined", (user) => {
            participants[user.connectionId] = user;
            document.getElementById('participantCount').textContent = Object.keys(participants).length;
            addActivityLog(`?? ${user.name} joined the quiz`);
        });

        connection.on("AnswerReceived", (userAnswer) => {
            const answersContainer = document.getElementById("answersContainer");

            const card = document.createElement('div');
            card.className = 'bg-white/90 p-4 rounded-lg shadow-sm';
            card.innerHTML = `
                <div class="font-semibold text-purple-700">${userAnswer.user.name}</div>
                <div class="mt-1 text-sm text-slate-700">${userAnswer.answer}</div>
            `;

            answersContainer.appendChild(card);
        });

        connection.on("NewQuestion", (question) => {
            document.getElementById("questionDisplay").textContent = question;
            document.getElementById("answersContainer").innerHTML = "";
            document.getElementById("resultsSection").classList.add("hidden");
        });

        connection.on("QuizResults", (data) => {
            console.log("QuizResults event received");
            console.log("Full data object:", data);
            
            const resultsList = document.getElementById("resultsList");
            resultsList.innerHTML = "";

            // Handle both Results (from C#) and results (from JSON serialization)
            const results = data?.Results || data?.results || [];
            console.log("Results array to process:", results);
            
            // Log first result to see property names
            if (results.length > 0) {
                console.log("First result object:", results[0]);
                console.log("First result keys:", Object.keys(results[0]));
            }

            if (!results || results.length === 0) {
                console.log("No results to display");
                resultsList.innerHTML = '<p class="text-gray-500">No participants or results</p>';
                document.getElementById("resultsSection").classList.remove("hidden");
                return;
            }

            results.forEach((result, idx) => {
                console.log(`Processing result ${idx}:`, result);
                const resultCard = document.createElement('div');
                resultCard.className = 'bg-white/90 p-4 rounded-lg';
                
                // Handle property name variations (name vs Name)
                const name = result.Name || result.name || 'Unknown';
                const switchCount = result.SwitchCount !== undefined ? result.SwitchCount : (result.switchCount || 0);
                
                let answersHtml = '';
                if (result.Answers && result.Answers.length > 0) {
                    answersHtml = result.Answers.map((a, aIdx) => {
                        console.log(`  Answer ${aIdx}:`, a);
                        return `<p class="text-sm text-slate-600">Q${aIdx + 1}: ${a.Answer || JSON.stringify(a)}</p>`;
                    }).join('');
                }

                resultCard.innerHTML = `
                    <div class="font-bold text-purple-700 mb-2">${name}</div>
                    <div class="text-xs text-orange-600 mb-2">Tab switches: ${switchCount}</div>
                    <div class="text-sm">${answersHtml || '<p class="text-gray-500">No answers submitted</p>'}</div>
                `;
                resultsList.appendChild(resultCard);
            });

            document.getElementById("resultsSection").classList.remove("hidden");
            addActivityLog("?? Quiz results displayed");
            console.log("Results display complete");
        });

        document.getElementById("nextQuestion").addEventListener("click", () => {
            connection.invoke("NextQuestion");
        });

        document.getElementById("clearAnswers").addEventListener("click", () => {
            document.getElementById("answersContainer").innerHTML = "";
        });

        document.getElementById("generateLink").addEventListener("click", () => {
            // simple uuid generator
            const id = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (
                c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4
            ).toString(16));

            const link = `${window.location.origin}/join/${id}`;
            const container = document.getElementById('generatedLinks');
            const el = document.createElement('div');
            el.className = 'mt-2 text-xs text-slate-600';
            el.textContent = link;
            container.appendChild(el);
        });

        document.getElementById("viewParticipants").addEventListener("click", () => {
            alert(`Participants:\n${Object.values(participants).map(p => p.name).join('\n')}` || 'No participants');
        });

        document.getElementById("showResults").addEventListener("click", () => {
            console.log("Show Results button clicked");
            console.log("Connection state:", connection.state);
            connection.invoke("ShowResults")
                .then(() => {
                    console.log("ShowResults invoked successfully");
                })
                .catch(err => {
                    console.error("ShowResults error:", err);
                    alert("Error showing results: " + err.message);
                });
        });

        // Register all connection event handlers BEFORE starting
        console.log("Registering connection event handlers...");
        connection.start()
            .then(() => {
                console.log("SignalR connection started successfully");
            })
            .catch(err => {
                console.error("Failed to start SignalR connection:", err);
            });
    </script>
}}