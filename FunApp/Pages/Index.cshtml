@page
@model IndexModel
@{
    ViewData["Title"] = "Fun Quiz App";
}

<div class="container mx-auto p-6">
    <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden grid grid-cols-1 md:grid-cols-3">
        <!-- Left: Host Panel -->
        <div class="md:col-span-2 p-8 bg-gradient-to-b from-purple-600 via-pink-500 to-orange-400 text-white">
            <div class="flex items-start justify-between">
                <div>
                    <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">Fun Quiz</h1>
                    <p class="mt-2 opacity-90">Play together in real time — display a question and collect answers from everyone.</p>
                </div>
                <div class="text-right">
                    <div class="text-sm opacity-90">Participants</div>
                    <div id="participantCount" class="text-2xl font-bold">0</div>
                </div>
            </div>

            <div class="mt-8 bg-white/10 rounded-xl p-6">
                <div id="questionDisplay" class="text-2xl md:text-3xl font-semibold">Waiting to start...</div>
                <div class="mt-4 text-sm opacity-80">Tip: Press Next Question to start the fun.</div>

                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4" id="answersContainer"></div>
            </div>

            <div class="mt-6 flex items-center gap-4">
                <button id="nextQuestion" class="bg-white text-purple-700 font-semibold px-5 py-3 rounded-lg shadow hover:scale-[1.02] transition">Next Question</button>
                <button id="clearAnswers" class="bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition">Clear Answers</button>
            </div>
        </div>

        <!-- Right: Join Info Panel -->
        <div class="p-6 bg-slate-50">
            <div class="bg-white rounded-xl p-6 shadow">
                <h3 class="text-lg font-semibold">Join this quiz</h3>
                <p class="text-sm text-slate-600 mt-2">Share this link with participants so they can join on their phones.</p>

                <div class="mt-4 flex gap-2">
                    <input id="joinUrl" type="text" readonly class="flex-1 p-3 rounded-lg border border-slate-200 text-sm" value="@Model.JoinUrl" />
                    <button onclick="copyJoinUrl()" class="px-4 py-2 bg-purple-600 text-white rounded-lg">Copy</button>
                </div>

                <div class="mt-6">
                    <h4 class="text-sm font-medium text-slate-700">Quick Controls</h4>
                    <div class="mt-3 grid grid-cols-1 gap-2">
                        <button id="generateLink" class="w-full py-2 rounded-md border border-dashed border-slate-200 text-sm">Generate User Link</button>
                        <button id="viewParticipants" class="w-full py-2 rounded-md bg-slate-100 text-sm">View Participants</button>
                    </div>
                </div>

                <div id="generatedLinks" class="mt-4 text-sm text-slate-600"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/signalr/dist/browser/signalr.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/quizHub")
            .withAutomaticReconnect()
            .build();

        let participants = {};

        connection.on("UserJoined", (user) => {
            participants[user.connectionId] = user;
            document.getElementById('participantCount').textContent = Object.keys(participants).length;
        });

        connection.on("AnswerReceived", (userAnswer) => {
            const answersContainer = document.getElementById("answersContainer");

            const card = document.createElement('div');
            card.className = 'bg-white/90 p-4 rounded-lg shadow-sm';
            card.innerHTML = `
                <div class="font-semibold text-purple-700">${userAnswer.user.name}</div>
                <div class="mt-1 text-sm text-slate-700">${userAnswer.answer}</div>
            `;

            answersContainer.appendChild(card);
        });

        connection.on("NewQuestion", (question) => {
            document.getElementById("questionDisplay").textContent = question;
            document.getElementById("answersContainer").innerHTML = "";
        });

        document.getElementById("nextQuestion").addEventListener("click", () => {
            connection.invoke("NextQuestion");
        });

        document.getElementById("clearAnswers").addEventListener("click", () => {
            document.getElementById("answersContainer").innerHTML = "";
        });

        document.getElementById("generateLink").addEventListener("click", () => {
            // simple uuid generator
            const id = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (
                c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4
            ).toString(16));

            const link = `${window.location.origin}/join/${id}`;
            const container = document.getElementById('generatedLinks');
            const el = document.createElement('div');
            el.className = 'mt-2 text-xs text-slate-600';
            el.textContent = link;
            container.appendChild(el);
        });

        document.getElementById("viewParticipants").addEventListener("click", () => {
            alert(`Participants:\n${Object.values(participants).map(p => p.name).join('\n')}` || 'No participants');
        });

        function copyJoinUrl() {
            const joinUrl = document.getElementById("joinUrl");
            joinUrl.select();
            document.execCommand("copy");
            alert("Join URL copied to clipboard!");
        }

        connection.start().catch(console.error);
    </script>
}